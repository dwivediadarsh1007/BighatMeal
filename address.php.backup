<?php
// Enable error reporting
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Start session if not already started
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

require_once 'config.php';

// Debug: Check if user is logged in
if (!isset($_SESSION['user_id'])) {
    die('User not logged in. Session data: ' . print_r($_SESSION, true));
}

if (!isset($_SESSION['user_id'])) {
    header('Location: login.php');
    exit();
}

// Handle address form submission
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    // Check if this is a delete request
    if (isset($_POST['delete_address'])) {
        try {
            // First check if there are any orders using this address
            $checkOrders = $conn->prepare("SELECT COUNT(*) as order_count FROM orders WHERE address_id = ? AND user_id = ?");
            $checkOrders->execute([$_POST['address_id'], $_SESSION['user_id']]);
            $result = $checkOrders->fetch(PDO::FETCH_ASSOC);
            
            if ($result['order_count'] > 0) {
                // If there are orders, don't delete but show a message
                $_SESSION['error'] = "Cannot delete this address because it's associated with existing orders. You can mark it as inactive instead.";
            } else {
                // No orders, safe to delete
                $stmt = $conn->prepare("DELETE FROM addresses WHERE id = ? AND user_id = ?");
                $stmt->execute([$_POST['address_id'], $_SESSION['user_id']]);
                
                if ($stmt->rowCount() > 0) {
                    $_SESSION['success'] = "Address deleted successfully!";
                } else {
                    $_SESSION['error'] = "Address not found or you don't have permission to delete it.";
                }
            }
            
            header('Location: ' . $_SERVER['PHP_SELF']);
            exit();
            
        } catch (Exception $e) {
            // If we get a foreign key constraint error, show a user-friendly message
            if (strpos($e->getMessage(), 'foreign key constraint') !== false) {
                $error = "Cannot delete this address because it's being used in existing orders. You can mark it as inactive instead.";
            } else {
                $error = "Error processing your request: " . $e->getMessage();
            }
        }
    } else {
        // Handle add new address
        try {
            $conn->beginTransaction();
            
            // Validate area_id and locality_id
            if (empty($_POST['locality_id']) || empty($_POST['area_id'])) {
                throw new Exception("Please select both locality and area");
            }
            
            $stmt = $conn->prepare("
                INSERT INTO addresses 
                (user_id, address_line1, address_line2, city, state, pincode, phone, 
                locality_id, area_id, landmark, is_default, created_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, 0, NOW())
            ");
            
            $stmt->execute([
                $_SESSION['user_id'],
                $_POST['address_line1'],
                $_POST['address_line2'] ?? '',
                $_POST['city'],
                $_POST['state'],
                $_POST['pincode'],
                $_POST['phone'],
                (int)$_POST['locality_id'],
                (int)$_POST['area_id'],
                $_POST['landmark'] ?? ''
            ]);
            
            // If this is the first address, set it as default
            if ($conn->query("SELECT COUNT(*) FROM addresses WHERE user_id = " . $_SESSION['user_id'])->fetchColumn() == 1) {
                $conn->exec("UPDATE addresses SET is_default = 1 WHERE id = " . $conn->lastInsertId());
            }
            
            $conn->commit();
            $_SESSION['success'] = "Address added successfully!";
            
        } catch (Exception $e) {
            $conn->rollBack();
            $error = "Error adding address: " . $e->getMessage();
        }
    }
}

// Check for success/error messages in session
if (isset($_SESSION['success'])) {
    $success = $_SESSION['success'];
    unset($_SESSION['success']);
}
if (isset($_SESSION['error'])) {
    $error = $_SESSION['error'];
    unset($_SESSION['error']);
}

// Debug: Check database connection
if (!isset($conn)) {
    die('Database connection failed');
}

try {
    // Check if tables exist
    $localitiesExist = $conn->query("SHOW TABLES LIKE 'localities'")->rowCount() > 0;
    $areasExist = $conn->query("SHOW TABLES LIKE 'areas'")->rowCount() > 0;
    $tablesExist = $localitiesExist && $areasExist;
    
    if ($tablesExist) {
        // Get user's addresses with locality and area information
        $query = "
            SELECT a.*, 
                   l.name as locality_name,
                   ar.name as area_name,
                   ar.delivery_charge,
                   ar.min_order_amount
            FROM addresses a
            LEFT JOIN localities l ON a.locality_id = l.id
            LEFT JOIN areas ar ON a.area_id = ar.id
            WHERE a.user_id = ? 
            ORDER BY a.is_default DESC, a.created_at DESC
        ";
    } else {
        // Fallback to basic address query if tables don't exist
        $query = "
            SELECT a.*, 
                   NULL as locality_name,
                   NULL as area_name,
                   NULL as delivery_charge,
                   NULL as min_order_amount
            FROM addresses a
            WHERE a.user_id = ? 
            ORDER BY a.is_default DESC, a.created_at DESC
        ";
    }
    
    // Debug: Log the query and parameters
    error_log('Address Query: ' . $query);
    error_log('User ID: ' . $_SESSION['user_id']);
    
    $stmt = $conn->prepare($query);
    if (!$stmt) {
        throw new Exception('Prepare failed: ' . print_r($conn->errorInfo(), true));
    }
    
    $executed = $stmt->execute([$_SESSION['user_id']]);
    if (!$executed) {
        throw new Exception('Execute failed: ' . print_r($stmt->errorInfo(), true));
    }
    
    $addresses = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // Debug: Log the results
    error_log('Fetched ' . count($addresses) . ' addresses');
    
} catch (Exception $e) {
    die('Database error: ' . $e->getMessage());
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Addresses - BighatMeal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <?php include 'includes/header.php'; ?>
    
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-3">
                <?php include 'includes/profile-menu.php'; ?>
            </div>
            
            <div class="col-md-9">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Delivery Addresses</h5>
                        
                        <?php if (isset($error)): ?>
                            <div class="alert alert-danger"><?php echo $error; ?></div>
                        <?php endif; ?>
                        
                        <?php if (isset($success)): ?>
                            <div class="alert alert-success"><?php echo $success; ?></div>
                        <?php endif; ?>
                        
                        <!-- Add New Address Form -->
                        <div class="mb-4">
                            <h6>Add New Address</h6>
                            <form method="POST" action="address.php">
                                <div class="mb-3">
                                    <label class="form-label">Address Line 1</label>
                                    <input type="text" name="address_line1" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Address Line 2 (Optional)</label>
                                    <input type="text" name="address_line2" class="form-control">
                                </div>
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">City</label>
                                        <input type="text" name="city" id="city" class="form-control" value="Jabalpur" readonly>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">State</label>
                                        <input type="text" name="state" class="form-control" value="Madhya Pradesh" readonly>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <label class="form-label">Pincode</label>
                                        <input type="text" name="pincode" class="form-control" required>
                                    </div>
                                </div>
                                <?php
                                // Fetch all active localities
                                $localities = $conn->query("SELECT * FROM localities ORDER BY name")->fetchAll(PDO::FETCH_ASSOC);
                                ?>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Locality</label>
                                        <select name="locality_id" id="locality_id" class="form-select" required onchange="loadAreas(this.value)">
                                            <option value="">Select Locality</option>
                                            <?php foreach ($localities as $locality): ?>
                                                <option value="<?= $locality['id'] ?>"><?= htmlspecialchars($locality['name']) ?></option>
                                            <?php endforeach; ?>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Area</label>
                                        <select name="area_id" id="area_id" class="form-select" required>
                                            <option value="">Select Locality First</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Landmark (Optional)</label>
                                    <input type="text" name="landmark" class="form-control" placeholder="e.g., Near Central Park, Opposite Mall">
                                </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone Number</label>
                                    <input type="tel" name="phone" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Add Address</button>
                            </form>
                        </div>
                        
                        <!-- Existing Addresses -->
                        <?php if (!empty($addresses)): ?>
                            <h6>My Addresses</h6>
                            <div class="list-group">
                                <?php foreach ($addresses as $address): ?>
                                    <div class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6><?php echo htmlspecialchars($address['address_line1']); ?></h6>
                                                <p class="mb-1 small">
                                                    <?php 
                                                    echo htmlspecialchars($address['address_line1']);
                                                    if (!empty($address['address_line2'])) {
                                                        echo ', ' . htmlspecialchars($address['address_line2']);
                                                    }
                                                    if (!empty($address['landmark'])) {
                                                        echo '<br>Landmark: ' . htmlspecialchars($address['landmark']);
                                                    }
                                                    ?>
                                                    <br>
                                                    <?php 
                                                    echo htmlspecialchars(
                                                        $address['area_name'] . ', ' . 
                                                        $address['locality_name'] . ', ' .
                                                        $address['city'] . ' - ' . 
                                                        $address['pincode']
                                                    );
                                                    ?>
                                                </p>
                                                <p class="mb-0 small text-muted">
                                                    Phone: <?php echo htmlspecialchars($address['phone']); ?>
                                                    <?php if (!empty($address['delivery_charge'])): ?>
                                                        <br>Delivery: ₹<?php echo number_format($address['delivery_charge'], 2); ?>
                                                        <?php if ($address['min_order_amount'] > 0): ?>
                                                            (Min. order: ₹<?php echo number_format($address['min_order_amount'], 2); ?>)
                                                        <?php endif; ?>
                                                    <?php endif; ?>
                                                </p>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-primary me-2">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <form method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this address? This action cannot be undone.');">
                                                    <input type="hidden" name="address_id" value="<?php echo $address['id']; ?>">
                                                    <input type="hidden" name="delete_address" value="1">
                                                    <button type="submit" class="btn btn-sm btn-danger">
                                                        <i class="bi bi-trash"></i> Remove
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                <?php endforeach; ?>
                            </div>
                        <?php else: ?>
                            <div class="alert alert-info">No addresses added yet. Please add your delivery address.</div>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <?php include 'includes/footer.php'; ?>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Function to load areas based on selected locality
        function loadAreas(localityId) {
            if (!localityId) {
                $('#area_id').html('<option value="">Select Locality First</option>');
                return;
            }
            
            $.ajax({
                url: 'get_areas.php',
                type: 'GET',
                data: { locality_id: localityId },
                dataType: 'json',
                success: function(response) {
                    var options = '<option value="">Select Area</option>';
                    if (response.length > 0) {
                        response.forEach(function(area) {
                            options += '<option value="' + area.id + '" data-delivery-charge="' + area.delivery_charge + '" data-min-order="' + area.min_order_amount + '">' + 
                                      area.name + ' (₹' + area.delivery_charge + ' delivery)' + 
                                      (area.min_order_amount > 0 ? ' - Min. order: ₹' + area.min_order_amount : '') + 
                                      '</option>';
                        });
                    } else {
                        options = '<option value="">No areas available in this locality</option>';
                    }
                    $('#area_id').html(options);
                    
                    // Update delivery charge and min order amount when area changes
                    updateAreaDetails();
                },
                error: function() {
                    $('#area_id').html('<option value="">Error loading areas</option>');
                }
            });
        }
        
        // Function to update area details when area is selected
        function updateAreaDetails() {
            var selectedOption = $('#area_id option:selected');
            var deliveryCharge = selectedOption.data('delivery-charge') || 0;
            var minOrder = selectedOption.data('min-order') || 0;
            
            // Update any UI elements that show these values
            $('.delivery-charge').text('₹' + deliveryCharge);
            $('.min-order').text('₹' + minOrder);
        }
        
        // Call updateAreaDetails when area selection changes
        $(document).on('change', '#area_id', updateAreaDetails);
        
    // Auto-hide alerts after 5 seconds
    document.addEventListener('DOMContentLoaded', function() {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            setTimeout(() => {
                alert.style.transition = 'opacity 0.5s';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            }, 5000);
        });
    });
    </script>
</body>
</html>
